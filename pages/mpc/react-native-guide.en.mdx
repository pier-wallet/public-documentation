# Tutorial for a wallet using MPC

The goal of this tutorial is to create a simple app that demonstrate how to use the pier MPC library:

- ‚õèÔ∏è using a simple create expo app (works with bare react native as well)
- üöß using fix username and password for authentication
- üìù user can sign transactions
- ‚õìÔ∏è user can interact with ETH and BTC

## Initialize a new app

```sh
npx create-expo-app -t expo-template-blank-typescript MyMPCApp

cd MyMPCApp

npm run ios
# or
npm run android
```

### Add dependencies

Add dependencies for the MPC library

```sh nnpm2yarn copy
npm i @pier-wallet/mpc-lib @pier-wallet/react-native-cloud-storage expo-secure-store
```

** !! If you are using react native without expo, use rn-secure-storage instead of expo-secure-store here !! **

Add dependencies to make node stuff work on react native (polyfills)

```sh npm2yarn copy
npm i @craftzdog/react-native-buffer stream-browserify react-native-quick-crypto react-native-quick-base64 react-native-url-polyfill
```

### Update configs (Expo)

```js
// babel.config.js
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ["babel-preset-expo"],
    plugins: [
      [
        "module-resolver",
        {
          root: ["./"],
          alias: {
            crypto: "react-native-quick-crypto",
            stream: "stream-browserify",
            buffer: "@craftzdog/react-native-buffer",
          },
        },
      ],
    ],
  };
};
```

```js
// app.json
{
  'expo': {
    // ...
    'plugins': [
      [
        'expo-build-properties',
        {
          'android': {
            'compileSdkVersion': 33,
            'targetSdkVersion': 34,
            'buildToolsVersion': '34.0.0',
            'packagingOptions': {
              'pickFirst': [
                'lib/x86/libcrypto.so',
                'lib/x86_64/libcrypto.so',
                'lib/armeabi-v7a/libcrypto.so',
                'lib/arm64-v8a/libcrypto.so'
              ]
            }
          },
          'ios': {
            'deploymentTarget': '17.0'
          }
        }
      ],
      '@pier-wallet/react-native-cloud-storage'
    ],
    // ...
    'ios': {
      'infoPlist': {
        'RCTAsyncStorageExcludeFromBackup': false,
        'NSFaceIDUsageDescription': 'We use FaceID to authenticate you to the app'
      },
    }
  }
}
```

### Update Configs (React Native)

```js
// metro.config.js

// ...
const extraNodeModules = {
  // ...
  crypto: require.resolve("react-native-quick-crypto"),
  stream: require.resolve("stream-browserify"),
  buffer: require.resolve("@craftzdog/react-native-buffer"),
  // ...
};
// ...
```

### Add config and google ID to use react native cloud storage

- For google drive integration, check the [Google Drive Docs](https://react-native-cloud-storage.vercel.app/docs/installation/configure-google-drive) - Make sure you get a Google Web Client ID
- For expo instructions, check the [Expo Docs](https://react-native-cloud-storage.vercel.app/docs/installation/expo)
- For bare react native specific, check the [React Native Docs](https://react-native-cloud-storage.vercel.app/docs/installation/react-native)

### Apply polyfills

```tsx copy filename='App.tsx'
// App.tsx - add this to the top of the file!!
import "react-native-url-polyfill/auto";
```

## Generate a key share (2 out of 3)

### Add pier MPC SDK

Wrap your app in pier MPC provider.
_Important_: make sure you import PierMpcProvider before you import any Component that uses it (e.g. Mpc.tsx). This is needed because PierMpcProvider includes some polyfills.

```tsx copy filename='App.tsx'
import { PierMpcProvider } from "@pier-wallet/mpc-lib/dist/package/react-native";

import React from "react";
import Mpc from "./Mpc";

export default function App() {
  return (
    <PierMpcProvider>
      {/* Mpc is a simple page that we will create later */}
      <Mpc />
    </PierMpcProvider>
  );
}
```

### Create a simple MPC wallet page

```tsx copy filename='Mpc.tsx'
import { KeyShare, SessionKind } from "@pier-wallet/mpc-lib";
import { PierMpcEthereumWallet } from "@pier-wallet/mpc-lib/dist/package/ethers-v5";
import { usePierMpc } from "@pier-wallet/mpc-lib/dist/package/react-native";
import { Button, View, Text } from "react-native";
import { useEffect, useState } from "react";

export default function Mpc() {
  const pierMpc = usePierMpc();

  const [keyShare, setKeyShare] = useState<KeyShare | null>(null);
  const [ethWallet, setEthWallet] = useState<PierMpcEthereumWallet | null>(
    null,
  );
  const [btcWallet, setBtcWallet] = useState<PierMpcBitcoinWallet | null>(null);

  const authenticateWithMpcServer = async () => {
    // we'll add this later
  };

  const generateKeyShare = async () => {
    // we'll add this later
  };

  const restoreWalletFromCloud = async () => {
    // we'll add this later
  };

  const [ethWallet, setEthWallet] = useState<PierMpcEthereumWallet | null>(
    null,
  );
  useEffect(() => {
    // we'll add this later
  }, [keyShare]);

  const sendEthereumTransaction = async () => {
    // we'll add this later
  };

  return (
    <>
      <View style={{ flex: 1, paddingTop: 100 }}>
        <Button
          title="Sign in as Test (fix)!"
          onPress={async () => {
            await pierMpc.auth.signInWithPassword({
              email: "mpc-lib-test@example.com",
              password: "123456",
            });

            console.log("signed in as test user");
          }}
        />
        <Button
          title="Generate Key Share"
          onPress={generateKeyShare}
          disabled={isLoading}
        />
        <Text selectable>ETH Address: {ethWallet?.address}</Text>
        <Text>PublicKey: {keyShare?.publicKey.join(",")}</Text>
        <Button
          title="Send Ethereum"
          onPress={sendEthereumTransaction}
          disabled={isLoading}
        />
      </View>
    </>
  );
}
```

### Generate the keyshare

This involves complex math and will take around 4 seconds.

```tsx copy filename='Mpc.tsx'
import { KeyShare, SessionKind } from "@pier-wallet/mpc-lib";
// ...
export default function Mpc() {
  // ...
  const generateKeyShare = async () => {
    try {
      console.log("generating local key share...");
      const [mainKeyShare, backupKeyShare] =
        await pierMpc.generateKeyShare2Of3();

      // Store main keyshare in secure storage (on device)
      await keyShareSecureLocalStorage.saveKeyShare(userId, mainKeyShare);

      // Store backup keyshare in cloud storage
      await keyShareCloudStorage.saveKeyShare(userId, backupKeyShare);

      setKeyShare(mainKeyShare);
    } catch (e) {
      console.error(e);
    }
  };

  return (
    <>
      <View style={{ flex: 1, paddingTop: 100 }}>
        <Button
          title="Generate Key Share"
          onPress={generateKeyShare}
          disabled={isLoading}
        />
        <Text>PublicKey: {keyShare?.publicKey.join(",")}</Text>
      </View>
    </>
  );
}
```

## Authenticate with the MPC Server

You can connect with our MPC Server using a username and password. This is not recommended for production, but it's a good way to get started.
In production, you can connect via a JWT token. Please use our [Dashboard](https://dashboard.pierwallet.com) to store the public key for us to validate the JWT token.

### Authentication with username and password

```tsx copy filename='Mpc.tsx'
// Mpc.tsx
export default function Mpc() {
  // ...
  const authenticateWithMpcServer = async () => {
    try {
      console.log("authenticating with MPC server...");
      await pierMpc.auth.signInWithPassword({
        email: "mpc-lib-test@example.com",
        password: "123456",
      });
    } catch (e) {
      console.error(e);
    }
  };

  // ...
}
```

### Authenticate with JWT token

```tsx copy filename='Mpc.tsx'
// Mpc.tsx
export default function Mpc() {
  // ...
  const authenticateWithMpcServer = async () => {
    try {
      console.log("authenticating with MPC server...");
      await pierMpc.auth.signInWithJwtToken({
        token: "YOUR_JWT_TOKEN",
      });
    } catch (e) {
      console.error(e);
    }
  };

  // ...
}
```

## Back up & Recover Keyshare

You have multiple ways to store and restore wallets:

- Device specific cloud storage (iCloud, Google Drive, etc.)
- Your own backend

We prefer to use the user's cloud storage to store the key share. This way, the user has full self-custody of the key share and can easily recover it on a new device.

```tsx copy filename='Mpc.tsx'
// Mpc.tsx
export default function Mpc() {
  // ...

  // we want to make sure we have connection to a cloud storage before we generate or restore the key share
  useEffect(() => {
    const checkCloudStorage = async () => {
      const isAvailable = await CloudStorage.isCloudAvailable();
      setIsCloudStorageAvailable(isAvailable);
      if (
        !isAvailable &&
        Platform.OS === "android" &&
        initialized &&
        !keyShare
      ) {
        await keyShareCloudStorage.signInWithGoogle(GOOGLE_WEB_CLIENT_ID);
        const isAvailable = await CloudStorage.isCloudAvailable();
        setIsCloudStorageAvailable(isAvailable);
      }
    };
    checkCloudStorage();
  }, [initialized]);

  // we want to load the wallet from local secure storage or cloud storage
  useEffect(() => {
    (async () => {
      setIsLoading(true);
      setKeyShare(null);

      // log in to MPC server
      await pierMpc.auth.signInWithPassword({
        email: "mpc-lib-test@example.com",
        password: "123456",
      });

      // restore main key share from secure local storage
      // TODO: Catch this "properly"
      const mainKeyShare = await keyShareSecureLocalStorage.getKeyShare(userId);

      if (!mainKeyShare && !isCloudStorageAvailable) {
        // no local key share BUT cloud storage is not available
        setIsLoading(false);
        setInitiliazed(true);
        return undefined;
      }
      if (!mainKeyShare) {
        // no local key share BUT cloud storage is available so we can try to restore from there
        await restoreWalletFromCloud();
        setIsLoading(false);
        return undefined;
      }

      // happy life - we have a local key share
      setKeyShare(mainKeyShare);
      setIsLoading(false);
      setInitiliazed(true);
    })();
  }, [pierMpc, isCloudStorageAvailable]);

  const restoreWalletFromCloud = async () => {
    try {
      console.log("restoring key share from cloud storage...");
      const contents = await CloudStorage.readdir("/");

      const backupKeyShare = await keyShareCloudStorage.getKeyShare(userId);
      if (!backupKeyShare) {
        return undefined;
      }
      setInitiliazed(true);
      setRestored(true);
      setKeyShare(backupKeyShare);

      // TODO: Allow user to create new account & transfer everything to new account, both chains
    } catch (e) {
      console.error(e);
    }
  };

  // ...
}
```

## Ethereum wallet

Install ethers to work with Ethereum - ethereum wallet is based on ethers v5 and implements `ethers.Signer` API.

```sh npm2yarn copy
npm i ethers@^5.7.2
```

### Create a wallet

```tsx copy filename='Mpc.tsx'
import { ethers } from "ethers";
// REMARK: Use should use your own ethers provider URL - this is just for demo purposes
const ethereumProvider = new ethers.providers.JsonRpcProvider(
  "https://rpc.sepolia.org",
);

export default function Mpc() {
  // ...

  const [ethWallet, setEthWallet] = useState<PierMpcEthereumWallet | null>(
    null,
  );
  useEffect(() => {
    if (!keyShare) return;
    (async () => {
      const signConnection = await pierMpc.establishConnection(
        SessionKind.SIGN,
        keyShare.partiesParameters,
      );
      const ethWallet = new PierMpcEthereumWallet(
        keyShare,
        signConnection,
        pierMpc,
        ethereumProvider,
      );
      setEthWallet(ethWallet);
    })();
  }, [keyShare]);

  return (
    // ...
    <Text selectable>ETH Address: {ethWallet?.address}</Text>
    // ...
  );
}
```

### Send Ethereum Transaction

**Important: you need to fund the address that is shown on the screen on the ethereum sepolia blockchain. You can use https://sepoliafaucet.com/ to do this**

**Important: you might expect failing transactions if you don't pick a stable RPC provider like alchemy**

**Important: This transaction will take around 4 seconds.**

```tsx copy filename='Mpc.tsx'
// ...

export default function Mpc() {
  //  ...
  const sendEthereumTransaction = async () => {
    if (!ethWallet) return;

    setIsLoading(true);
    try {
      // send 1/10 of the balance to the zero address
      const receiver = ethers.constants.AddressZero;
      const balance = await ethWallet.getBalance();
      const amountToSend = balance.div(10);

      // sign the transaction locally & send it to the network once we have the full signature
      const tx = await ethWallet.sendTransaction({
        to: receiver,
        value: amountToSend,
      });
      console.log("tx", tx.hash);
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    // ...
    <Button
      title="Send Ethereum"
      onPress={sendEthereumTransaction}
      disabled={isLoading}
    />
    // ...
  );
}
```

## Bitcoin wallet

### Create a Bitcoin wallet

```tsx copy filename='Mpc.tsx'
import {
  PierMpcBitcoinWallet,
  PierMpcBitcoinWalletNetwork,
} from "@pier-wallet/mpc-lib/dist/package/bitcoin";
// ...

export default function Mpc() {
  // ...
  const [btcWallet, setBtcWallet] = useState<PierMpcBitcoinWallet | null>(null);
  useEffect(() => {
    if (!keyShare) return;
    (async () => {
      const signConnection = await pierMpc.establishConnection(
        SessionKind.SIGN,
        keyShare.partiesParameters,
      );
      const btcWallet = new PierMpcBitcoinWallet(
        keyShare,
        PierMpcBitcoinWalletNetwork.Testnet,
        signConnection,
        pierMpc,
      );
      setBtcWallet(btcWallet);
    })();
  }, [keyShare]);

  return (
    // ...
    <Text selectable>BTC Address: {btcWallet?.address}</Text>
    // ...
  );
}
```

### Send Bitcoin Transaction

**Important: you need to fund the address that is shown on the screen on the bitcoin test blockchain. You can use https://bitcoinfaucet.uo1.net/send.php to do this**

This involves complex math and will take around 4 seconds.

```tsx copy filename='Mpc.tsx'
export default function Mpc() {
  // ...

  const sendBitcoinTransaction = async () => {
    if (!btcWallet) return;

    setIsLoading(true);
    try {
      const receiver = "tb1qw2c3lxufxqe2x9s4rdzh65tpf4d7fssjgh8nv6"; // testnet faucet
      const amountToSend = 800n; // 0.00000800 BTC = 800 satoshi
      const feePerByte = 1n; // use a fee provider to get a more accurate fee estimate - otherwise check minimum fee manually

      // create a transaction request
      const txRequest = await btcWallet.populateTransaction({
        to: receiver,
        value: amountToSend,
        feePerByte,
      });

      // sign the transaction locally & send it to the network once we have the full signature
      const tx = await btcWallet.sendTransaction(txRequest);
      console.log("tx", tx.hash);
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    // ...
    <Button
      title="Send Bitcoin"
      onPress={sendBitcoinTransaction}
      disabled={isLoading}
    />
    // ...
  );
}
```
